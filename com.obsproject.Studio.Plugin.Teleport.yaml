id: com.obsproject.Studio.Plugin.Teleport
branch: stable
runtime: com.obsproject.Studio
runtime-version: stable
sdk: org.kde.Sdk//6.8
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang
build-extension: true
separate-locales: false
build-options:
  prefix: /app/plugins/Teleport
  libdir: lib/obs-plugins
  append-path: /usr/lib/sdk/golang/bin
modules:
  - name: obs-teleport
    buildsystem: simple
    build-options:
      env:
        - GOBIN=/app/bin
        - GOFLAGS="-buildmode=c-shared"
        - GOPATH=/run/build/obs-teleport/go
        - CGO_CFLAGS="-I/app/include/obs"
        - CGO_LDFLAGS="-L/app/lib -Wl,-z,relro,-z,now -Wl,--as-needed -lturbojpeg
          -lobs -lobs-frontend-api"
    build-commands:
      - go build -mod=vendor -ldflags "-compressdwarf=false -linkmode external -X
        main.version=0.7.5" -v -o "${FLATPAK_DEST}/lib/obs-plugins/obs-teleport.so"
        .
      # some dependencies have files with 444 permissions, this prevents cleanup so we're changing everything to 644
      - chmod -R u+w *
    post-install:
      - install -Dm644 --target-directory=${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
    sources:
      - type: git
        url: https://github.com/fzwoch/obs-teleport.git
        tag: 0.7.5
        commit: e7834e0a270928e89d24e529d775001d5729667a
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)
      - type: file
        path: com.obsproject.Studio.Plugin.Teleport.metainfo.xml
      # Workaround for Go modules generated by github.com/dennwc/flatpak-go-mod
      - dest: vendor
        path: modules.txt
        type: file
      - dest: vendor/github.com/schollz/peerdiscovery
        sha256: e55194336853b98f2bc4f4caa7c0a15ce6afc1abefd46be9a2b0e1c694136753
        strip-components: 3
        type: archive
        url: https://proxy.golang.org/github.com/schollz/peerdiscovery/@v/v1.7.6.zip
      - dest: vendor/golang.org/x/net
        sha256: 24d4f49b7e781763942533d5a5acc49ebd054e05c50bf4402b264695ef8d10c5
        strip-components: 3
        type: archive
        url: https://proxy.golang.org/golang.org/x/net/@v/v0.43.0.zip
      - dest: vendor/golang.org/x/sys
        sha256: dc3c20611168aaa8fda0d71999be1a5222a0ba57bc767c978a590e41ff2ede35
        strip-components: 3
        type: archive
        url: https://proxy.golang.org/golang.org/x/sys/@v/v0.35.0.zip
